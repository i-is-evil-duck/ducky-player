<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini MP3 Player</title>
    <script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/colorthief@2.3.2/dist/color-thief.umd.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
    <style>
        :root {
            --accent-color: 74, 144, 226; /* Default Blue */
            --accent-color-dark: 50, 110, 180; /* A darker shade for hover effects */
        }
        body {
            font-family: 'Inter', sans-serif;
            position: relative;
            overflow: hidden;
            transition: all 0.5s ease;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(20px);
            z-index: -1;
            transition: background-image 0.5s ease-in-out;
            transform: scale(1.1);
        }
        
        body.has-background::before {
            animation: pan-background 30s ease-in-out infinite alternate;
        }

        @keyframes pan-background {
            0% {
                background-position: 50% 50%;
            }
            100% {
                background-position: 60% 60%;
            }
        }
        
        .scroll-container::-webkit-scrollbar, .lyrics-view::-webkit-scrollbar {
            width: 8px;
        }
        .scroll-container::-webkit-scrollbar-thumb, .lyrics-view::-webkit-scrollbar-thumb {
            background-color: #3f3f46;
            border-radius: 9999px;
        }
        .scroll-container::-webkit-scrollbar-track, .lyrics-view::-webkit-scrollbar-track {
            background-color: #27272a;
        }
        .scrolling-container {
            overflow: hidden;
            width: 100%;
        }
        .scrolling-title {
            white-space: nowrap;
            display: inline-block;
            animation: scroll-left-loop 15s linear infinite;
        }
        @keyframes scroll-left-loop {
            0% {
                transform: translateX(100%);
            }
            100% {
                transform: translateX(-100%);
            }
        }
        .truncated {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .lyrics-view {
            white-space: pre-wrap;
            max-height: 96;
        }
        
        .queue-item:hover .remove-btn {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .modal-container.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: #27272a;
            border-radius: 12px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }

        .modal-container.active .modal-content {
            transform: translateY(0);
        }

        .accent-bg {
            background-color: rgb(var(--accent-color));
        }

        .accent-hover-bg:hover {
            background-color: rgb(var(--accent-color-dark));
        }

        .accent-text {
            color: rgb(var(--accent-color));
        }

        .accent-text-active {
            color: rgb(var(--accent-color));
        }

        .accent-range-thumb::-webkit-slider-thumb {
            background-color: rgb(var(--accent-color));
        }
    </style>
</head>
<body class="bg-zinc-900 text-white flex items-center justify-center min-h-screen p-4">
    <div id="app-container" class="bg-zinc-800 bg-opacity-70 backdrop-blur-md rounded-2xl shadow-2xl p-6 md:p-8 flex flex-col md:flex-row gap-8 w-full max-w-6xl transition-all duration-300">
        <div class="flex-shrink-0 w-full md:w-1/3 flex flex-col items-center justify-center transition-all duration-300">
            <img id="cover-art" src="https://placehold.co/400x400/27272a/fafafa?text=No+Cover" alt="Album Cover" class="w-full h-auto max-w-md rounded-xl shadow-lg aspect-square object-cover transition-transform duration-300 transform-gpu hover:scale-105">
            <div class="scrolling-container mt-4 text-2xl font-bold text-center">
                <h2 id="current-title" class="truncated">No song playing</h2>
            </div>
            <p id="current-artist" class="text-zinc-400 text-center truncate">Select or drag & drop a file</p>
        </div>

        <div class="flex-grow flex flex-col gap-6 md:gap-8 transition-all duration-300">
            <div id="song-queue-container" class="flex-grow bg-zinc-700 bg-opacity-50 p-4 rounded-xl shadow-inner scroll-container overflow-y-auto max-h-96 min-h-96">
                <h3 class="text-xl font-semibold mb-3 text-zinc-300">Song Queue</h3>
                <ul id="song-queue" class="space-y-2">
                </ul>
            </div>
            <div id="lyrics-view" class="lyrics-view hidden flex-grow bg-zinc-700 bg-opacity-50 p-4 rounded-xl shadow-inner scroll-container overflow-y-auto max-h-96 min-h-96 text-sm text-zinc-300">
                <h3 class="text-xl font-semibold mb-3 text-zinc-300">Lyrics</h3>
                <p id="lyrics-text" class="text-zinc-300">No lyrics found for this song.</p>
            </div>

            <div class="flex flex-col items-center gap-4">
                <audio id="audio-player" class="hidden"></audio>
                <div class="flex items-center w-full gap-2 text-xs text-zinc-400">
                    <span id="current-time">0:00</span>
                    <div class="w-full h-2 bg-zinc-700 rounded-full cursor-pointer relative" id="progress-bar-container">
                        <div id="progress-bar" class="h-full rounded-full transition-all duration-200" style="width: 0%; background-color: rgb(var(--accent-color));"></div>
                    </div>
                    <span id="duration-time">0:00</span>
                </div>
                <div class="flex items-center justify-center gap-6 md:gap-8 text-3xl">
                    <button id="shuffle-btn" class="p-2 rounded-full hover:bg-zinc-700 transition-colors" title="Shuffle">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M14.868 9.132L19 5v4h2V3h-6v2h2.868l-4.132 4.132-1.414-1.414 4.132-4.132H13V3h6v6h-2V7.132L14.868 11.264l-1.414-1.414zM16 16v-2h2v-2h-2v2h-2v2h2v2h-2v2h2v-2zM3 13h2v-2H3v2zm0 4h2v-2H3v2zm0 4h2v-2H3v2zm4-8h2v-2H7v2zm0 4h2v-2H7v2zm0 4h2v-2H7v2zm4-8h2v-2h-2v2zm0 4h2v-2h-2v2zm0 4h2v-2h-2v2zm-8-8h2v-2H3v2zm0 4h2v-2H3v2z"/></svg>
                    </button>
                    <button id="loop-btn" class="p-2 rounded-full hover:bg-zinc-700 transition-colors" title="Loop">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 4.5V2L8 6l4 4V7.5c3.25 0 6 2.75 6 6s-2.75 6-6 6-6-2.75-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
                    </button>
                    <button id="prev-btn" class="p-3 rounded-full hover:bg-zinc-700 transition-colors" title="Previous">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                    </button>
                    <button id="play-pause-btn" class="p-4 rounded-full accent-bg hover:accent-hover-bg transition-colors shadow-lg" title="Play/Pause">
                        <svg id="play-icon" class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        <svg id="pause-icon" class="w-10 h-10 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                    </button>
                    <button id="skip-btn" class="p-3 rounded-full hover:bg-zinc-700 transition-colors" title="Skip">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M16 6h2v12h-2zm-10 6l8.5 6V6z"/></svg>
                    </button>
                    <button id="lyrics-btn" class="p-2 rounded-full hover:bg-zinc-700 transition-colors" title="Lyrics">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 18.25c-2.485 0-4.5-2.015-4.5-4.5s2.015-4.5 4.5-4.5 4.5 2.015 4.5 4.5-2.015 4.5-4.5 4.5zm0-7c-1.38 0-2.5 1.12-2.5 2.5s1.12 2.5 2.5 2.5 2.5-1.12 2.5-2.5-1.12-2.5-2.5-2.5zm-5 13.25h10v-2h-10v2zm1-4h8v-2h-8v2zm-2-4h12v-2h-12v2zm-2-4h16v-2h-16v2z"/></svg>
                    </button>
                </div>
                <div class="flex items-center gap-2 mt-4 w-full">
                    <svg class="w-6 h-6 text-zinc-400" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                    <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1" class="w-full h-1 bg-zinc-700 rounded-lg appearance-none cursor-pointer range-thumb-blue-500 accent-range-thumb">
                </div>
            </div>
        </div>

        <div class="absolute bottom-6 left-6 flex items-center justify-center">
            <label for="file-input" class="bg-zinc-700 p-3 rounded-full shadow-lg cursor-pointer hover:bg-zinc-600 transition-colors flex items-center gap-2">
                <svg class="w-5 h-5 text-zinc-300" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg>
                <span class="text-sm font-medium text-zinc-300 hidden md:block">Add Files</span>
            </label>
            <input type="file" id="file-input" accept="audio/mp3" multiple class="hidden">
        </div>

        <div id="drag-drop-overlay" class="absolute inset-0 bg-zinc-900 bg-opacity-70 backdrop-blur-sm rounded-2xl flex items-center justify-center hidden">
            <p class="text-4xl font-bold text-zinc-400 drop-shadow-lg">Drag & Drop Your MP3s Here!</p>
        </div>
    </div>

    <div id="clear-playlist-modal" class="modal-container">
        <div class="modal-content">
            <h4 class="text-xl font-bold mb-4">Clear Playlist</h4>
            <p class="text-zinc-300 mb-6">Are you sure you want to clear the entire playlist? This action cannot be undone.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-clear-btn" class="px-6 py-2 rounded-lg bg-zinc-600 hover:bg-zinc-500 transition-colors">Cancel</button>
                <button id="confirm-clear-btn" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 transition-colors">Clear</button>
            </div>
        </div>
    </div>

    <div id="message-box" class="fixed bottom-10 right-10 bg-zinc-700 text-white p-4 rounded-xl shadow-lg transition-transform duration-300 transform translate-x-full">
        <p id="message-text"></p>
    </div>

    <script>
        // Store all DOM elements
        const appContainer = document.getElementById('app-container');
        const audioPlayer = document.getElementById('audio-player');
        const coverArt = document.getElementById('cover-art');
        const currentTitle = document.getElementById('current-title');
        const currentArtist = document.getElementById('current-artist');
        const songQueue = document.getElementById('song-queue');
        const lyricsView = document.getElementById('lyrics-view');
        const lyricsText = document.getElementById('lyrics-text');
        const fileInput = document.getElementById('file-input');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const prevBtn = document.getElementById('prev-btn');
        const skipBtn = document.getElementById('skip-btn');
        const shuffleBtn = document.getElementById('shuffle-btn');
        const loopBtn = document.getElementById('loop-btn');
        const lyricsBtn = document.getElementById('lyrics-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const dragDropOverlay = document.getElementById('drag-drop-overlay');
        const volumeSlider = document.getElementById('volume-slider');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const body = document.body;
        const currentTimeEl = document.getElementById('current-time');
        const durationTimeEl = document.getElementById('duration-time');
        const clearPlaylistModal = document.getElementById('clear-playlist-modal');
        const confirmClearBtn = document.getElementById('confirm-clear-btn');
        const cancelClearBtn = document.getElementById('cancel-clear-btn');
        const colorThief = new ColorThief();

        // State variables for the music player
        let playlist = [];
        let filesMap = new Map();
        let currentSongIndex = -1;
        let isPlaying = false;
        let isShuffling = false;
        let isLooping = false;
        let showLyrics = false;
        let shuffledPlaylist = [];

        // --- Utility Functions ---

        function showMessage(text) {
            messageText.textContent = text;
            messageBox.classList.remove('translate-x-full');
            setTimeout(() => {
                messageBox.classList.add('translate-x-full');
            }, 3000);
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            const paddedSeconds = remainingSeconds < 10 ? `0${remainingSeconds}` : remainingSeconds;
            return `${minutes}:${paddedSeconds}`;
        }

        function saveState() {
            try {
                const playlistMetadata = playlist.map(song => ({
                    title: song.title,
                    artist: song.artist,
                    originalFileName: song.originalFileName,
                    hasCoverArt: !!song.coverArtUrl
                }));
                localStorage.setItem('mp3PlayerPlaylist', JSON.stringify(playlistMetadata));
                localStorage.setItem('mp3PlayerCurrentIndex', currentSongIndex);
            } catch (e) {
                console.error("Could not save to local storage:", e);
                showMessage("Could not save playlist to local storage. Your playlist may be too large.");
            }
        }

        function loadState() {
            try {
                const storedPlaylistMetadata = localStorage.getItem('mp3PlayerPlaylist');
                const storedIndex = localStorage.getItem('mp3PlayerCurrentIndex');
                if (storedPlaylistMetadata) {
                    playlist = JSON.parse(storedPlaylistMetadata).map(song => ({
                        ...song,
                        src: null,
                        fileLoaded: false
                    }));
                    renderPlaylist();
                    if (storedIndex) {
                        currentSongIndex = parseInt(storedIndex, 10);
                        if (currentSongIndex >= 0 && currentSongIndex < playlist.length) {
                            updateUI();
                            showMessage("Playlist loaded from previous session. Please re-add files to play.");
                        }
                    }
                }
            } catch (e) {
                console.error("Could not load from local storage:", e);
                showMessage("Could not load playlist from local storage. It may be corrupted.");
            }
        }

        function parseMetadata(filename) {
            const name = filename.replace(/\.mp3$/, '');
            const parts = name.split(' - ');
            if (parts.length >= 2) {
                return {
                    artist: parts[0].trim(),
                    title: parts.slice(1).join(' - ').trim()
                };
            }
            return {
                artist: 'Unknown Artist',
                title: name.trim()
            };
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function updateBackground(imageUrl) {
            let styleElement = document.getElementById('dynamic-background-style');
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = 'dynamic-background-style';
                document.head.appendChild(styleElement);
            }

            const defaultGradient = 'linear-gradient(to bottom, #18181b, #27272a)';
            const backgroundCSS = imageUrl ? `url('${imageUrl}')` : defaultGradient;

            styleElement.innerHTML = `
                body::before {
                    content: '';
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-image: ${backgroundCSS};
                    background-size: cover;
                    background-position: center;
                    filter: blur(20px);
                    z-index: -1;
                    transition: background-image 0.5s ease-in-out;
                    transform: scale(1.1);
                }
            `;
            
            if (imageUrl) {
                body.classList.add('has-background');
            } else {
                body.classList.remove('has-background');
            }
        }

        // --- UI Rendering Functions ---

        function renderPlaylist() {
            songQueue.innerHTML = '';
            const currentList = isShuffling ? shuffledPlaylist : playlist;
            currentList.forEach((song, index) => {
                const isCurrent = (isShuffling ? shuffledPlaylist.findIndex(s => s.originalFileName === playlist[currentSongIndex]?.originalFileName) : currentSongIndex) === index;
                const isPlayable = filesMap.has(song.originalFileName);
                const li = document.createElement('li');
                li.className = `p-3 rounded-lg cursor-pointer transition-colors flex items-center justify-between text-zinc-300 relative group queue-item ${isCurrent ? 'accent-bg text-white' : 'hover:bg-zinc-600'} ${isPlayable ? '' : 'opacity-50'}`;
                
                li.innerHTML = `
                    <div class="flex-grow">
                        <div class="font-semibold truncate">${song.title}</div>
                        <div class="text-sm text-zinc-400 truncate ${isCurrent ? 'text-zinc-200' : ''}">${song.artist}</div>
                    </div>
                    <button class="remove-btn absolute right-3 top-1/2 -translate-y-1/2 p-1 rounded-full bg-red-600 text-white opacity-0 transition-opacity duration-200 hover:bg-red-700 pointer-events-none" title="Remove song">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                    </button>
                    ${!isPlayable ? '<span class="text-xs text-red-400 ml-2">File not found</span>' : ''}
                `;

                li.addEventListener('click', (e) => {
                    if (e.target.closest('.remove-btn')) return;
                    const mainIndex = playlist.findIndex(s => s.originalFileName === song.originalFileName);
                    playSong(mainIndex);
                });

                li.querySelector('.remove-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeSong(index);
                });
                
                songQueue.appendChild(li);
            });

            if (playlist.length > 0) {
                const clearAllLi = document.createElement('li');
                clearAllLi.className = 'p-3 rounded-lg cursor-pointer transition-colors bg-red-600 text-white hover:bg-red-700 font-semibold text-center mt-4';
                clearAllLi.textContent = 'Clear All';
                clearAllLi.addEventListener('click', showClearAllConfirmation);
                songQueue.appendChild(clearAllLi);
            }

            saveState();
        }

        function displayLyrics() {
            if (currentSongIndex > -1) {
                const song = playlist[currentSongIndex];
                if (song.lyrics) {
                    lyricsText.textContent = song.lyrics;
                } else {
                    lyricsText.textContent = 'No lyrics found for this song.';
                }
            } else {
                lyricsText.textContent = 'No song playing.';
            }
        }

        function updateUI() {
            if (currentSongIndex > -1) {
                const song = playlist[currentSongIndex];
                currentTitle.textContent = song.title;
                currentArtist.textContent = song.artist;
                
                const titleContainerWidth = currentTitle.parentElement.offsetWidth;
                const tempSpan = document.createElement('span');
                tempSpan.style.visibility = 'hidden';
                tempSpan.style.whiteSpace = 'nowrap';
                tempSpan.style.fontSize = getComputedStyle(currentTitle).fontSize;
                tempSpan.style.fontWeight = getComputedStyle(currentTitle).fontWeight;
                tempSpan.textContent = song.title;
                document.body.appendChild(tempSpan);
                const textWidth = tempSpan.offsetWidth;
                document.body.removeChild(tempSpan);

                if (textWidth > titleContainerWidth) {
                    currentTitle.classList.remove('truncated');
                    currentTitle.classList.add('scrolling-title');
                } else {
                    currentTitle.classList.remove('scrolling-title');
                    currentTitle.classList.add('truncated');
                }

                if (song.coverArtUrl) {
                    const img = new Image();
                    img.crossOrigin = 'Anonymous';
                    img.onload = () => {
                        try {
                            const rgb = colorThief.getColor(img);
                            document.documentElement.style.setProperty('--accent-color', `${rgb[0]}, ${rgb[1]}, ${rgb[2]}`);
                            // Calculate a darker shade for hover effect
                            const darkRgb = rgb.map(c => Math.max(0, c - 40));
                            document.documentElement.style.setProperty('--accent-color-dark', `${darkRgb[0]}, ${darkRgb[1]}, ${darkRgb[2]}`);
                        } catch (e) {
                            console.error("ColorThief failed:", e);
                            document.documentElement.style.setProperty('--accent-color', '74, 144, 226');
                            document.documentElement.style.setProperty('--accent-color-dark', '50, 110, 180');
                        }
                    };
                    img.src = song.coverArtUrl;
                    coverArt.src = song.coverArtUrl;
                    updateBackground(song.coverArtUrl);
                } else {
                    coverArt.src = `https://placehold.co/400x400/27272a/fafafa?text=${encodeURIComponent(song.title)}`;
                    updateBackground(null);
                    // Reset to default color
                    document.documentElement.style.setProperty('--accent-color', '74, 144, 226');
                    document.documentElement.style.setProperty('--accent-color-dark', '50, 110, 180');
                }

                displayLyrics();
            } else {
                currentTitle.textContent = 'No song playing';
                currentArtist.textContent = 'Select or drag & drop a file';
                coverArt.src = 'https://placehold.co/400x400/27272a/fafafa?text=No+Cover';
                currentTitle.classList.remove('scrolling-title');
                currentTitle.classList.add('truncated');
                updateBackground(null);
                displayLyrics();
                // Reset to default color
                document.documentElement.style.setProperty('--accent-color', '74, 144, 226');
                document.documentElement.style.setProperty('--accent-color-dark', '50, 110, 180');
            }
            
            // Re-apply correct active classes after UI update
            shuffleBtn.classList.toggle('accent-text-active', isShuffling);
            loopBtn.classList.toggle('accent-text-active', isLooping);
            lyricsBtn.classList.toggle('accent-text-active', showLyrics);
            playPauseBtn.classList.toggle('accent-bg', isPlaying);
            playPauseBtn.classList.toggle('hover:accent-hover-bg', isPlaying);

            renderPlaylist();
        }

        // --- Core Player Logic ---

        function playSong(index, shouldPlay = true) {
            if (index < 0 || index >= playlist.length) {
                return;
            }

            const song = playlist[index];
            const file = filesMap.get(song.originalFileName);

            if (!file) {
                showMessage(`File "${song.originalFileName}" not found. Please re-add it.`);
                return;
            }

            if (currentSongIndex !== index) {
                if (audioPlayer.src) {
                    URL.revokeObjectURL(audioPlayer.src);
                }
                const url = URL.createObjectURL(file);
                audioPlayer.src = url;
            }

            currentSongIndex = index;
            updateUI();
            if (shouldPlay) {
                audioPlayer.play().catch(e => {
                    console.error("Play failed:", e);
                    showMessage("Autoplay failed. Please click play.");
                });
                isPlaying = true;
            } else {
                isPlaying = false;
            }

            playIcon.classList.toggle('hidden', isPlaying);
            pauseIcon.classList.toggle('hidden', !isPlaying);
            playPauseBtn.classList.toggle('accent-bg', isPlaying);

            saveState();
        }

        function removeSong(indexToRemove) {
            const songToRemove = playlist[indexToRemove];
            if (!songToRemove) return;

            playlist.splice(indexToRemove, 1);
            filesMap.delete(songToRemove.originalFileName);

            if (currentSongIndex === indexToRemove) {
                audioPlayer.pause();
                isPlaying = false;
                if (playlist.length > 0) {
                    const newIndex = indexToRemove < playlist.length ? indexToRemove : 0;
                    playSong(newIndex, false);
                } else {
                    currentSongIndex = -1;
                    updateUI();
                }
            } else if (currentSongIndex > indexToRemove) {
                currentSongIndex--;
                updateUI();
            }
            
            if (isShuffling) {
                shuffledPlaylist = shuffleArray(playlist);
            }

            renderPlaylist();
            showMessage(`Removed "${songToRemove.title}" from the queue.`);
        }

        function doClearAllSongs() {
            playlist = [];
            filesMap.clear();
            currentSongIndex = -1;
            isPlaying = false;
            audioPlayer.pause();
            audioPlayer.src = '';
            
            shuffledPlaylist = [];

            updateUI();
            showMessage("Playlist cleared.");
            hideConfirmationModal();
        }

        function showClearAllConfirmation() {
            if (playlist.length === 0) return;
            clearPlaylistModal.classList.add('active');
        }

        function hideConfirmationModal() {
            clearPlaylistModal.classList.remove('active');
        }

        function togglePlayPause() {
            if (playlist.length === 0) return;
            if (isPlaying) {
                audioPlayer.pause();
            } else {
                if (currentSongIndex === -1) {
                    playSong(0);
                } else {
                    playSong(currentSongIndex);
                }
            }
            isPlaying = !isPlaying;
            playIcon.classList.toggle('hidden', isPlaying);
            pauseIcon.classList.toggle('hidden', !isPlaying);
            playPauseBtn.classList.toggle('accent-bg', isPlaying);
        }

        function nextSong() {
            if (playlist.length === 0) return;
            const currentList = isShuffling ? shuffledPlaylist : playlist;
            let nextIndex = currentList.findIndex(song => song.originalFileName === playlist[currentSongIndex].originalFileName) + 1;
            if (nextIndex >= currentList.length) {
                nextIndex = 0;
            }
            const songIndexInPlaylist = playlist.findIndex(s => s.originalFileName === currentList[nextIndex].originalFileName);
            playSong(songIndexInPlaylist);
        }

        function prevSong() {
            if (playlist.length === 0) return;
            const currentList = isShuffling ? shuffledPlaylist : playlist;
            let prevIndex = currentList.findIndex(song => song.originalFileName === playlist[currentSongIndex].originalFileName) - 1;
            if (prevIndex < 0) {
                prevIndex = currentList.length - 1;
            }
            const songIndexInPlaylist = playlist.findIndex(s => s.originalFileName === currentList[prevIndex].originalFileName);
            playSong(songIndexInPlaylist);
        }

        // --- File Processing Logic ---

        function getLyricsFromFile(tags) {
            if (tags.lyrics && tags.lyrics.lyrics) {
                return tags.lyrics.lyrics;
            }
            if (tags.lyrics && typeof tags.lyrics === 'object' && tags.lyrics.text) {
                return tags.lyrics.text;
            }
            if (tags.lyrics && typeof tags.lyrics === 'string') {
                return tags.lyrics;
            }
            if (tags.USLT && tags.USLT.text) {
                return tags.USLT.text;
            }
            if (tags.UNSYNCEDLYRICS && tags.UNSYNCEDLYRICS.data) {
                return tags.UNSYNCEDLYRICS.data;
            }
            return null;
        }

        function getFileMetadata(file) {
            return new Promise((resolve, reject) => {
                jsmediatags.read(file, {
                    onSuccess: tag => {
                        let artist = tag.tags.artist || 'Unknown Artist';
                        let title = tag.tags.title || file.name.replace(/\.mp3$/, '').trim();
                        let coverArtUrl = null;
                        let lyrics = getLyricsFromFile(tag.tags);

                        if (tag.tags.picture) {
                            const { format, data } = tag.tags.picture;
                            let base64String = "";
                            for (let i = 0; i < data.length; i++) {
                                base64String += String.fromCharCode(data[i]);
                            }
                            coverArtUrl = `data:${format};base64,${btoa(base64String)}`;
                        }
                        
                        resolve({ title, artist, originalFileName: file.name, coverArtUrl, lyrics });
                    },
                    onError: error => {
                        reject(error);
                    }
                });
            });
        }

        async function processFiles(files) {
            for (const file of files) {
                if (file.type === 'audio/mpeg' && !filesMap.has(file.name)) {
                    try {
                        const metadata = await getFileMetadata(file);
                        playlist.push(metadata);
                        filesMap.set(file.name, file);
                    } catch (error) {
                        console.error(`Error reading tags from file: ${file.name}`, error);
                        const { title, artist } = parseMetadata(file.name);
                        playlist.push({ title, artist, originalFileName: file.name, coverArtUrl: null, lyrics: null });
                        filesMap.set(file.name, file);
                    }
                }
            }

            if (currentSongIndex === -1 && playlist.length > 0) {
                playSong(0, false);
            }
            renderPlaylist();
        }

        // --- Event Listeners ---
        fileInput.addEventListener('change', (event) => {
            if (event.target.files) {
                processFiles(event.target.files);
            }
        });
        
        appContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragDropOverlay.classList.remove('hidden');
        });

        appContainer.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dragDropOverlay.classList.add('hidden');
        });

        appContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            dragDropOverlay.classList.add('hidden');
            const files = [];
            if (e.dataTransfer.items) {
                for (let i = 0; i < e.dataTransfer.items.length; i++) {
                    const item = e.dataTransfer.items[i];
                    if (item.kind === 'file' && item.type === 'audio/mpeg') {
                        files.push(item.getAsFile());
                    }
                }
            } else {
                for (let i = 0; i < e.dataTransfer.files.length; i++) {
                    const file = e.dataTransfer.files[i];
                    if (file.type === 'audio/mpeg') {
                        files.push(file);
                    }
                }
            }
            processFiles(files);
        });

        function toggleLyricsView() {
            showLyrics = !showLyrics;
            lyricsBtn.classList.toggle('accent-text-active', showLyrics);
            songQueue.parentElement.classList.toggle('hidden', showLyrics);
            lyricsView.classList.toggle('hidden', !showLyrics);
            if (showLyrics) {
                displayLyrics();
            }
        }

        playPauseBtn.addEventListener('click', togglePlayPause);
        prevBtn.addEventListener('click', prevSong);
        skipBtn.addEventListener('click', nextSong);
        volumeSlider.addEventListener('input', (e) => {
            audioPlayer.volume = e.target.value;
        });

        shuffleBtn.addEventListener('click', () => {
            isShuffling = !isShuffling;
            shuffleBtn.classList.toggle('accent-text-active', isShuffling);
            if (isShuffling) {
                shuffledPlaylist = shuffleArray(playlist);
            } else {
                shuffledPlaylist = [];
            }
            renderPlaylist();
        });

        loopBtn.addEventListener('click', () => {
            isLooping = !isLooping;
            loopBtn.classList.toggle('accent-text-active', isLooping);
        });

        lyricsBtn.addEventListener('click', toggleLyricsView);

        audioPlayer.addEventListener('ended', () => {
            if (isLooping) {
                audioPlayer.currentTime = 0;
                audioPlayer.play();
            } else {
                nextSong();
            }
        });

        audioPlayer.addEventListener('timeupdate', () => {
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressBar.style.width = `${progress}%`;
            currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
        });

        audioPlayer.addEventListener('loadedmetadata', () => {
            durationTimeEl.textContent = formatTime(audioPlayer.duration);
        });

        progressBarContainer.addEventListener('click', (e) => {
            const clickX = e.offsetX;
            const containerWidth = progressBarContainer.offsetWidth;
            const newTime = (clickX / containerWidth) * audioPlayer.duration;
            audioPlayer.currentTime = newTime;
        });

        confirmClearBtn.addEventListener('click', doClearAllSongs);
        cancelClearBtn.addEventListener('click', hideConfirmationModal);
        clearPlaylistModal.addEventListener('click', (e) => {
            if (e.target === clearPlaylistModal) {
                hideConfirmationModal();
            }
        });

        // Initial setup on page load
        window.onload = loadState;
    </script>
</body>
</html>